<html lang="en">
<head>
  <title> Google Genomics API </title>
  <script src="/js/jquery.js" charset="utf-8"></script>
  <script src="/js/bootstrap.js"></script>
  <!-- The googlegenomics plugin can be sourced directly from rawgit.com -->
  <script src="/js/googlegenomics.jquery.js"></script>
  
  <script src="/js/biojs/biojs-vis-sequence.js"></script>
  <script src="/js/biojs/biojs-io-fasta.js"></script>
  <script src="http://wzrd.in/bundle/jquery-browser-plugin@0.0.6"></script>

  <script src="http://wzrd.in/bundle/pviz@0.1.12-2"></script>

  <link type="text/css" rel="stylesheet" href="http://cdn.rawgit.com/greenify/pviz/master/src/css/pviz-core.css">
  
  <link rel="stylesheet" href="/js/bootstrap.min.css">
  
  
  <style type="css/text">
    body {
      font-family: sans-serif;
    }
  
    form {
      text-align: center;
      width: 400px;
      padding: 1em;
      border: 1px solid #CCC;
      border-radius: 1em;
    }
    form div + div {
      margin-top: 1em;
    }
    label {
      display: inline-block;
      width: 90px;
      text-align: right;
    }
    
    input {
      font: 1em sans-serif;
      width: 300px;
      --moz-box-sizing: border-box;
      box-sizing: border-box;
      border: 1px solid #999;
    }

    input[name="button"] {
      width: 100px;
    }
    
  </style>
</head>


<!-- <input type="text" class="form-control" id="callSetId" value="10473108253681171589-0"/>
-->
<body>
<h1 id="DEMO" style="text-align: center"> Google Genomics API </h1>
<h4 id="DEMO" style="text-align: right; margin-right: 200px"> Datasets -> RG -> Reads ---> Reference -> pviz visualization </h4>

<br>
<form id="dataInput" action = "" methos="post" >
  <div class="projectNumber">
    <label for="projectNumber"> Project Number: </label> 
    <input id="projectNumber", value="761052378059"> <text style="font-size: 12"> default value (my data: 639017132977)</text>
    <input type="button" name="button" value="Get_Dataset ID" style="margin-left: 10px" onclick="getUserInput_dataSet()"> </input>
  </div>
  <div class="jobType"  hidden>
  <label for="jobType"> <p>Datasets - Job type: </p></label> &nbsp;
    <input type="radio" name="jobType1" value="create"> Create &nbsp;
    <input type="radio" name="jobType1" value="delete"> Delete &nbsp;
    <input type="radio" name="jobType1" value="get"> Get &nbsp;
    <input type="radio" name="jobType1" value="list" checked = "checked"> List &nbsp;
    <input type="radio" name="jobType1" value="update"> Update &nbsp;
  </div>
 
  <div class="isPublic" hidden>
    <label for="isPublic"> isPublic: </label>
    <input type="checkbox" id="isPublic" value="public" checked> </div> 
  </div>
  <div class="name" hidden>
    <label for="name"> Name: </label> 
    <input id="name"> 
  </div>
  <div class="pageSize" hidden>
    <label for="pageSize"> Page size: </label> 
    <input id="pageSize"> 
  </div>

   
  <div class="read_datasetID"><div class="form-group">
    <label for="datasetId">Read groupsets - dataset ID: </label>
    <select class="id-control" id="datasetIdSelector" onchange="updateReadGroupsetsIdMenu(this)">
    <option type="text" class="form-control" id="datasetId" value="NuLL"> NULL </option>
    </select>
    <ouput id="datasetIdCount" name="datasetIdCount">  </ouput>
  
  <div class="read_dataset_name" hidden>
    <label for="read_dataset_name"> Read groupsets - name: </label> 
    <input id="read_dataset_name"> 
  </div>
  <div class="read_pagesize" hidden>
    <label for="read_pagesize"> Read groupsets - pagesize: </label> 
    <input id="read_pagesize" value=5> 
  </div>

  <div class="form-group">
    <label for="reads_groupsetId"> ReadGroupsetsID: </label>
    <select class="id-control" id="reads_groupsetIdSelector" onchange="search_Reads(this)">
    <option type="text" class="form-control" id="reads_groupsetId" value="NuLL"> NULL </option>
    </select>
  </div>
  <div class="reads_groupsetID" hidden>
    <label for="reads_groupsetID"> ReadGroupsetsID: </label> 
    <input id="reads_groupsetID" value = 'testValue'> 
  </div>
  <div class="reads_referenceName">
    <label for="reads_referenceName"> ReferenceName: </label> 
    <input id="reads_referenceName" value=1> 
  </div>
  <div class="reads_start">
    <label for="reads_start"> Start position: </label> 
    <input id="reads_start" value=13000000>  
  </div>
  <div class="reads_end">
    <label for="reads_end"> End position: </label> 
    <input id="reads_end" value=13000250> 
  </div>
  <div class="reads_pageSize">
    <label for="reads_pageSize"> PageSize: </label> 
    <input id="reads_pageSize" value=3>  
  </div>
  <br>
  <div class="submit_button">
    <input type="button" name="button" value="Get_Dataset ID" onclick="getUserInput_ref(this)" hidden> </input>
    <input type="button" name="button" value="Get_Readgroupset ID" onclick="get_ReadgroupsetID()" hidden> </input>
    <input type="button" name="button" value="Search_Reads" onclick="search_Reads()" hidden> </input>
  </div>


  <!--///////////////////////////
  /////////// REFERENCES ////////
  /////////////////////////////// -->
  
  <div class="form-group">
    <label for="callSetId">ReferenceSet ID</label>
    <select class="id-control" id="refSetIdSelector" onchange="getRefSetId(this)">
    <option type="text" class="form-control" id="refSetId_init" value="NuLL"> Selet ID </option>
    <option type="text" class="form-control" id="refSetId" value="EMud_c37lKPXTQ"> GRCh38 </option>
    </select>
    <br>
    <label for="callSetId">All References</label>
    <select class="id-control" id="refIdSelector" onchange="getRefName(this)">
    <option type="text" class="form-control" id="refID_init" value="NuLL"> Select ref. </option>
    </select>
    <ouput id="refCount" name="refCount">  </ouput>
    <br>
    <label for="callSetId">Valid References</label>
    <select class="id-control" id="refIdSelector_valid" onchange="getRefName(this)">
    <option type="text" class="form-control" id="valid_refId_init" value="NuLL"> Select.. </option>
    </select>
    <ouput class="button valid_ref" id="valid_refCount" name="valid_refCount">  </ouput>
    <input type="button" name="getValid_button" value="refresh_valid_ref." onclick="getValidReferences()"> </input>
  </div>
  
  
   <div class="query_seq" hidden>
    <label for="query_seq"> Query sequence: </label> 
    <input id="query_seq">  
  </div>
  <div class="submit_button">
    
    <input type="button" name="button" value="Sequence" onclick="getUserInput_ref(this)"> </input>
    <input type="button" name="button2" value="Alignment" onclick="getAlignment()" hidden> </input>
  </div>
</form>

<br>

<p id="outContainer_title" style="margin-left: 50px"><b>================== OUTPUT  ==================</b></p>

<div id="pviz_canvas"> </div>
<div id="seq_holder"> </div>
<div id="chk_match"> </div>
<div class="output_container" id="output_container" style="width: 600px; margin-top: 20px; margin-left: 50px;"> 
</div>

<script type="text/javascript">

var JSONdata_ref;   // stores return data
var JSONdata_dSets;
var startPosition_global = -1;
var endPosition_global = -1;
var margin_Startposition = -1;
var margin_Endposition = -1;

/////////////////////// pviz /////////////////////
var pviz;
var seqEntry;

///////////////////////  datasets variables ///////////////////
var callSetId = "NULL";
var jobType = "NULL";
var jobType_chk = 0;
var dataset_reads = [];          // the result data from reads // id, alignedSeq, position
var test_data_params;           // used the function 'search_Reads'
var JSONdata_dataSets = [];


///////////////////////  reference variables ///////////////////
// My ID
var clientId = "639017132977-tnhsbqtbrb5tjmrbb6q0clojthsank45.apps.googleusercontent.com";
var refSetId = "NULL";
var jobType;                 
var userCommand;
var JSONdata_getRefId;
var JSONdata_getRefName;
var refIdList;
var refNameList = [];
var refNameLIst_valid = [];
var refID_input;
var getUserEvent = "";
var query_seq;
var seq_start;
var seq_end;
var align_pos_start = [];
var align_pos_end = [];
var pviz;
var pviz_chk;
var testSeq;          // function sendData_no_body
var testSeq_string;   // function sendData_no_body
var basesData;        // function sendData_no_body
var ref_name;
///////////////////////////////////////////////////////////////////


// clientId chk
if (!clientId) {
  alert('A client ID is required. Please push one to the url: ' +
      'http://localhost:8000/traitviewer#my-client-id');
} else {
  console.log("clientId: " + clientId);
  $.initGenomics({clientId: clientId});
}

(function() {
  j = document.getElementsByName("jobType1");
    for (var i=0; i<j.length; i++) {
      if(j[i].checked) { 
        jobType = j[i].value 
      }
    }
}());

function get_ReadgroupsetID() {
  var inForm = document.forms[0];
  var RG_datasetID = [];
  RG_datasetID.push(inForm.read_datasetID.value);       // store as list
  var RG_pagesize = inForm.read_pagesize.value;
  var RG_name = inForm.read_dataset_name.value;
  console.log(RG_datasetID + " // " + RG_pagesize + " // " + RG_name);

  var params = {
          datasetIds: RG_datasetID,
          pageSize: RG_pagesize,
          //name: RG_name
        };
  var url = '/readgroupsets/search';
  var method = 'POST';
  console.log(" ## REQUEST_RG : " + JSON.stringify(params) );
  sendData_RG(params, url, method);   // list[0] == callSetId
}

function search_Reads(option) {
  var inForm = document.forms[0];
  var reads_groupsetID = [];
  //reads_groupsetID.push(inForm.reads_groupsetID.value);       // store as list
  var form_name = option[option.selectedIndex].text;
  var form_id = option[option.selectedIndex].value;
  reads_groupsetID.push(form_id);
  
  var reads_referenceName = inForm.reads_referenceName.value;
  var reads_start = inForm.reads_start.value;
  var reads_end = inForm.reads_end.value;

  startPosition_global = reads_start;
  endPosition_global = reads_end;
  var margin = parseInt( (endPosition_global - startPosition_global) / 2)
  margin_Startposition = startPosition_global - margin;
  margin_Endposition = parseInt(endPosition_global) +  margin;

  var reads_pageSize = inForm.reads_pageSize.value;

  var params = {
          readGroupSetIds: reads_groupsetID,
          referenceName: reads_referenceName,
          start: reads_start,
          end: reads_end,
          pageSize: reads_pageSize
  }
  test_data_params = params;

  var url = '/reads/search';
  var method = 'POST';
  console.log(" REQUEST_READS : " + JSON.stringify(params));
  sendData_Reads (params, url, method);
}

function getUserInput_dataSet() {
  $("#datasetIdSelector").empty();
  document.getElementById("output_container").innerHTML = "";
  var InputList = [];
  var inForm = document.forms[0];
  
  var callSetId = "NULL"; //callSetId;
  var projectNumber = inForm.projectNumber.value;
  var datasetId = "NULL" //inForm.datasetId.value;
  var isPublic = inForm.isPublic.checked;   // true: public, false: private
  var name = inForm.name.value;
  var pageSize = inForm.pageSize.value;
  j = document.getElementsByName("jobType1");
  for (var i=0; i<j.length; i++) {
    if(j[i].checked) { 
      jobType = j[i].value 
    }
  } 
  var pageToken = "NULL" //inForm.pageToken.value;
  
  console.log("\t=============== USER INPUT ==============="
              +"\n\tJobType: " + jobType 
              +"\n\tCallsetID: " + callSetId 
              +"\n\tProjectNumber: " + projectNumber
              +"\n\tDatasetId: " + datasetId
              +"\n\tisPublic: " + isPublic
              +"\n\tName: " + name
              +"\n\tPageSize: " + pageSize
              +"\n\tPageToken: " + pageToken
              );
  
  InputList.push(callSetId);        // 0    
  InputList.push(projectNumber);    // 1
  InputList.push(datasetId);        // 2
  InputList.push(isPublic);         // 3
  InputList.push(name);             // 4
  InputList.push(pageSize);         // 5
  InputList.push(pageToken);        // 6
  
  prepSendData_datasets(InputList);
}

function prepSendData_datasets(list) {
  switch (jobType) {
    case "create": {
        var params = {
          projectNumber: list[1],
          name: list[4],
          isPublic: list[3]
        };
        var url = '/datasets';
        var method = 'POST';
        console.log(" ## REQUEST : " + JSON.stringify(params) );
        sendData(list[0], params, url, method);   // list[0] == callSetId
      break;
    }
    case "delete": {
        var params = {
          datasetId: list[2]
          };
          var url = '/datasets/datasetId';
          var method = 'DELETE'
          console.log(" ## REQUEST : " + JSON.stringify(params) );
          sendData(list[0], params, url, method);   // list[0] == callSetId
        break;
    }
    case "get": {
        var params = {
          datasetId: list[2] 
        };
        var url = '/datasets/datasetId';
        var method = 'GET';
        console.log(" ## REQUEST : " + JSON.stringify(params) );
        sendData(list[0], params, url, method);   // list[0] == callSetId
      break;
    }
    case "list": {
      if (list[1] == "") { 
        var params = {
          //projectNumber: list[1],
          pageSize: list[5],
          pageToken: list[6] 
        }; 
      }
      else {
        var params = {
          projectNumber: list[1],
          pageSize: list[5],
          pageToken: list[6] 
        };
      }
        var url = '/datasets';
        var method = 'GET';
        console.log(" ## REQUEST : " + JSON.stringify(params) );
        sendData(list[0], params, url, method);   // list[0] == callSetId
      break;
    }
    case "update": {

      break;
    }
  }
}

function sendData (callSetId, params, url, method) {
  $.genomicsAjax ( url, {
    version: 'v1beta2',
    method: method,
    data: JSON.stringify(params),
    success: function(json) {
      console.log("#### Success to return JSON! ####");
      JSONdata_dataSets = [];
      //document.getElementById('output_container').innerHTML += "<p><b> Success! </b></p>";

      JSONdata = json;
      //document.getElementById('output_container').innerHTML += '<br />' + '<b>CallSet ID: </b>' + JSONdata;
      if (method == "GET" && jobType == "list") {
        var br = "<br>";
        var count = 0;
        console.log("ProjectNumber? : " + params.projectNumber);
        if(params.projectNumber == undefined) {
          for (var i=0; i<JSONdata.datasets.length; i++) {
            JSONdata_dataSets.push(JSONdata.datasets[i]);
            $('#output_container').append('<b> '+ '<br> datasetId: ' + JSONdata.datasets[i].id 
                                                        + '<br> projectNumber: ' + JSONdata.datasets[i].projectNumber
                                                        + '<br> name: ' + JSONdata.datasets[i].name
                                                        + br + '</b>');
          }
          count = count + 1;
        }
        else {
          for (var i=0; i<JSONdata.datasets.length; i++) {
            if (JSONdata.datasets[i].projectNumber == params.projectNumber) {
              JSONdata_dataSets.push(JSONdata.datasets[i]);
              $('#output_container').append('<b> '+ '<br> datasetId: ' + JSONdata.datasets[i].id 
                                                          + '<br> projectNumber: ' + JSONdata.datasets[i].projectNumber
                                                          + '<br> name: ' + JSONdata.datasets[i].name
                                                          + br + '</b>');
            }
            count = count + 1;
          }
        }
        updateDatasetIdMenu(JSONdata_dataSets);           // update dataSetId dropdown menu
      }
      else if (method == "GET") {
        for (var i in JSONdata.datasets) {
          var br = "";
          var count = 0;
          for (var prop in JSONdata.datasets[i]) {
            if (count == 3) {br = "<br>"}
            if (JSONdata.datasets[i].hasOwnProperty(prop)) {
              document.getElementById('output_container').innerHTML += '<br /><b>' + prop +":</b> "+ JSONdata.datasets[i][prop] + br;  
            }
            count = count + 1;
          }
        }
      }
      else {   
        for (var prop in JSONdata) {
          if (JSONdata.hasOwnProperty(prop)) {
            document.getElementById('output_container').innerHTML += '<br /><b>' + prop +":</b> "+ JSONdata[prop];  } };
      }
    }
  });
}

function sendData_RG (params, url, method) {
  $.genomicsAjax ( url, {
    version: 'v1beta2',
    method: method,
    data: JSON.stringify(params),
    success: function(json) {
      console.log("#### Success to return JSON! ####");
      JSONdata_RG = json;
      console.log(json);
      $('#output_container').empty();

      for (var i in json.readGroupSets) {
        var br = "";
        var count = 0;
        for (var prop in json.readGroupSets[i]) {
          if (count == 5) { br = "<br>"};
          if (json.readGroupSets[i].hasOwnProperty(prop)) {
            document.getElementById('output_container').innerHTML += '<br /><b>' + prop +":</b> "+ json.readGroupSets[i][prop] + br;  
            }
          count = count + 1;
        }
      }
      updateReadsMenu(json);          // update ReadGroupsetsId      
    }
  });
}

function sendData_Reads (params, url, method) {
  $.genomicsAjax ( url, {
    version: 'v1beta2',
    method: method,
    data: JSON.stringify(params),
    success: function(json) {
      console.log("#### Success to return JSON! ####");
      dataset_reads = [];
      JSONdata_Reads = json;
      console.log(json);

      $('#output_container').empty();

      for (var i in json.alignments) {
        document.getElementById('output_container').innerHTML += '<br>';  
        var br = "";
        var count = 0;
        for (var prop in json.alignments[i]) {
          //if (count == 5) { br = "<br>"};
          //if (json.alignments[i][prop]=='info') { br = "<br>"};
          if (json.alignments[i].hasOwnProperty(prop)) {
            document.getElementById('output_container').innerHTML += '<br /><b>' + prop +":</b> "+ json.alignments[i][prop] + br;  
            }
          count = count + 1;
        }
      }
      for (var i=0; i<json.alignments.length; i++) {
        dataset_reads.push({ id: json.alignments[i].id,
                            fragName: json.alignments[i].fragmentName,
                            referenceName: json.alignments[i].alignment.position.referenceName,
                            position: json.alignments[i].alignment.position.position,
                            alignedSeq: json.alignments[i].alignedSequence
        })
      }
    }
  });
}

function updateDatasetIdMenu (json) {       // usin JSONdata_dataSets
  $('#datasetIdSelector').empty();
  var dIdmenu = document.getElementById("datasetIdSelector");
  var padding = document.createElement("option");
  padding.text = "Select";
  for (var i=0; i<json.length; i++) {
    if (i == 0) { dIdmenu.appendChild(padding) }
    var tmp = document.createElement("option");
    tmp.value = json[i].id;
    tmp.text = json[i].name;
    dIdmenu.appendChild(tmp);
  }
}


function updateReadGroupsetsIdMenu (option) {
  var form_name = option[option.selectedIndex].text;
  var form_id = option[option.selectedIndex].value;
  var RG_datasetID = [];
  RG_datasetID.push(form_id);       // store as list
  var RG_pagesize = 5;
  var RG_name = "";
  //console.log(RG_datasetID + " // " + RG_pagesize + " // " + RG_name);

  var params = {
          datasetIds: RG_datasetID,
          pageSize: RG_pagesize,
          //name: RG_name
        };
  var url = '/readgroupsets/search';
  var method = 'POST';
  console.log(" ## REQUEST_RG : " + JSON.stringify(params) );
  sendData_RG(params, url, method);   // list[0] == callSetId

}

//var tmp_Json;
function updateReadsMenu (json) {             // using JSONdata_RG
  //tmp_Json = json;
  $('#reads_groupsetIdSelector').empty();
  var reads_menu = document.getElementById("reads_groupsetIdSelector");
  var padding = document.createElement("option");
  padding.text = "Select";
  for (var i=0; i<json.readGroupSets.length; i++) {
    if (i == 0) { reads_menu.appendChild(padding) }
    var tmp = document.createElement("option");
    tmp.value = json.readGroupSets[i].id;
    tmp.text = json.readGroupSets[i].name;
    reads_menu.appendChild(tmp);
  }
}



//////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////           REFERENCE             ////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////



function getRefSetId(option) {
  refSetId = option[option.selectedIndex].value;
  console.log("Reference Set ID: " + refSetId);
  updateReference(refSetId);            // send refSetId to Google and receive refId list 
                                        // then update the list that user can see.
  setTimeout (function() {
    getValidReferences();                 // delay for AJAX processing time.
  }, 2000);
}                                       


function getRefName(option) {
  var refId_raw = option[option.selectedIndex].value;
  var refId_split = refId_raw.split(" ");
  var refId = refId_split[0];
  console.log("Reference: " + refId);
  var params = '';                      // no request body to get refId using refSetId
  var url = '/references/' + refId;
  var method = 'GET';
  var job = 'getRefName'
  sendData_no_body (refId, params, url, method, job);   
}

function updateReference(refSetId) {    // send refSetId to Google
  var params = '';                      // no request body to get refId using refSetId
  var url = '/referencesets/' + refSetId;
  var method = 'GET';
  var job = 'getRefId'
  //console.log(" ## REQUEST : " + JSON.stringify(params) );
  sendData_no_body (refSetId, params, url, method, job);  
}


function getValidReferences() {
  var dfrd = $.Deferred();
  console.log("Get valid references")
  var params = '';                      
  var method = 'GET';
  var job = 'getRefNameList'
  refNameList = [];
  //var refIdOnly = refIdList.referenceIds;
  //console.log(" ## REQUEST : " + JSON.stringify(params) );
  for (var i=0; i<refIdList.referenceIds.length; i++) {
    var url = '/references/' + refIdList.referenceIds[i];
    sendData_no_body (refIdList.referenceIds[i], params, url, method, job);  
  }

  setTimeout (function() {
    validChkReferences();                 // delay for AJAX processing time.
  }, 2000);
 
}

function validChkReferences() {
  console.log("==== VALID CHECK ====");
  //var count = 0;
  refNameLIst_valid = [];       // init.
  //refNameList = [];
  console.log("refNameList count = " + refNameList.length);
  for (var i=0; i<refNameList.length; i++) {
    //console.log(refNameList[i].name);
    var check_int = parseInt(refNameList[i].name);
    if (check_int > 0 && check_int < 23) { 
      refNameLIst_valid.push(refNameList[i]);
    }
    else if (refNameList[i].name == 'X' || refNameList[i].name == 'x' || refNameList[i].name == 'Y' || refNameList[i].name == 'y') { 
      refNameLIst_valid.push(refNameList[i]); 
    }
  }

  updateReferenceMenu_validList(refNameLIst_valid);           // update dropdown menu
}

function getUserInput_ref(option) {
  document.getElementById("output_container").innerHTML = "";
  //location.reload();
  
  userCommand = "sequence";
  $("#pviz_canvas").empty();
  $('#chk_match').empty();
  var inForm = document.forms[0];
  var start;
  var end;
  if (margin_Startposition < 0) {
    start = inForm.reads_start.value;
    end = inForm.reads_end.value;
  }
  else {
    start = margin_Startposition;
    end = margin_Endposition;
  }
  //var start = inForm.startPosition.value;
  //var end = inForm.endPosition.value;
  //query_seq = inForm.query_seq.value;
  if (option.value == "Sequence") {
    var doc = document.getElementById("refIdSelector_valid");
  }
  else {
    var doc = document.getElementById("refIdSelector");
  }
  var refId_raw = doc.options[doc.selectedIndex].text;
  var refId_split = refId_raw.split(" ");
  var ref_Id = refId_split[0];
  ref_name = refId_split[1].split(/[()]+/).filter(function(e) { return e} );
  refID_input = ref_Id;
  
  console.log("\t=============== USER INPUT ==============="
              +"\n\tReference ID: " + ref_Id
              +"\n\tReference name: " + ref_name
              +"\n\tStart: " + start
              +"\n\tEnd: " + end
              );  
  
  if (start > end) {
    alert("Err - Start position # should be lower than End position #");
    return;
  }
  //var params = 'start='+start+'&end='+end;          // no request body to get refId using refSetId
  var params = {start : start, end : end};                      

  var url = '/references/' + ref_Id + '/bases';
  var method = 'GET';
  var job = 'getBases'
  console.log(" ## REQUEST : " + JSON.stringify(params) );
  sendData_no_body (refSetId, params, url, method, job);  
  //prepSendData(ref_Id, start, end);

  var myPviz = setTimeout(function() {genPviz(testSeq_string, ref_Id, params)}, 2000);
}

function genPviz (seq, ref_Id, params) {
  var lclchk = localStorageSupported();
  var Aseqs = [];                                 // store data_reads info
  var posList = [];                               // alignedSeq, fragName, position,
  var fragName = [];
  for (var i=0; i<dataset_reads.length; i++) {
    Aseqs.push(dataset_reads[i].alignedSeq);
    posList.push(dataset_reads[i].position);
    fragName.push(dataset_reads[i].fragName);
  }
  console.log(lclchk);
  if(lclchk) {
    localStorage.setItem("startPosition", margin_Startposition);
    localStorage.setItem("sequence", seq);
    localStorage.setItem("ref_Id", ref_Id);
    localStorage.setItem("ref_Name", ref_name);
    localStorage.setItem("start", params.start);
    localStorage.setItem("end", params.end);
    localStorage.setItem("alignedSeq", Aseqs);
    localStorage.setItem("alignedPos", posList);
    localStorage.setItem("fragName", fragName);
    window.open("draw_pviz.html");    

  }

  /////////////////  drawing pviz //////////////////////
  // implement pviz in this file conflicts with jquery
  // solution: make separate file then call it explicitly (draw_pviz.html)
  //////////////////////////////////////////////////////
  /*
  console.log("Pviz seq: " + seq);                   
  $("pviz_canvas").empty();
  pviz = require("pviz");
  var pviz_canvas = document.getElementById("pviz_canvas");
  pviz_chk = pviz;
  seqEntry = new pviz.SeqEntry({
    sequence : seq
  });
  
  new pviz.SeqEntryAnnotInteractiveView({
    model : seqEntry,
    el : pviz_canvas
  }).render(); 
  */
}

///////////////////////////////////////////////////////////////////////////
// This testing is important to propery use pviz implementation
//    because using localStorage to pass main html variables to pviz page.
///////////////////////////////////////////////////////////////////////////
function localStorageSupported() {      
 try {
  return "localStorage" in window && window["localStorage"] !== null;
 } catch (e) {
  return false;
 }
}

function getAlignment() {
  document.getElementById("output_container").innerHTML = "";
  $('#chk_match').empty();  
  userCommand = "alignment";
  var inForm = document.forms[0];
  var start;
  var end;
  if (margin_Startposition < 0) {
    start = inForm.reads_start.value;
    end = inForm.reads_end.value;
  }
  else {
    start = margin_Startposition;
    end = margin_Endposition;
  }
  //var start = inForm.startPosition.value;
  //var end = inForm.endPosition.value;
  seq_start = start;
  seq_end = end;
  query_seq = inForm.query_seq.value;
  if (query_seq == "") { 
    alert("Please fill Query Sequence section!"); 
    return;
  }
  var doc = document.getElementById("refIdSelector");
  var ref_Id = doc.options[doc.selectedIndex].text;
  refID_input = ref_Id;
  if (start > end) {
    alert("Err - Start position # should be lower than End position #");
    return;
  }

  var params = {start : start, end : end};                      
  var url = '/references/' + ref_Id + '/bases';
  var method = 'GET';
  var job = 'getBases'
  sendData_no_body (refSetId, params, url, method, job);  
}

/*
function prepSendData_allRefs(ref_Id, start, end) {
  var params = {
    projectNumber: ref_Id,
    pageSize: start,
    pageToken: end 
  };
  var url = '/datasets';
  var method = 'GET';
  console.log(" ## REQUEST : " + JSON.stringify(params) );
  sendData(list[0], params, url, method);   // list[0] == callSetId
}
*/

function sendData_with_body (callSetId, params, url, method) {
  $.genomicsAjax ( url, {
    version: 'v1beta2',
    method: method,
    data: JSON.stringify(params),
    success: function(json) {
      console.log("#### Success to return JSON! ####");
      document.getElementById('output_container').innerHTML += "<p><b> Sucess! </b></p>";

      JSONdata_ref = json;
      //document.getElementById('output_container').innerHTML += '<br />' + '<b>CallSet ID: </b>' + JSONdata;
      
      }
    });
}

function sendData_no_body (callSetId, params, url, method, jobType) {
  $.genomicsAjax ( url, {
    version: 'v1beta2',
    method: method,
    data: params,
    success: function(json) {
      console.log("#### Success to return JSON! ####");
      //document.getElementById('output_container').innerHTML += "<p><b> Sucess! </b></p>";

      if (jobType == 'getRefId') {
        JSONdata_getRefId = json;
        refIdList = json;
        updateReferenceMenu(refIdList);
      }
      else if (jobType == 'getRefName') {
        $('#output_container').empty();
        $('#output_container').append ('<b> '+'<br> id: '+ json.id + 
                                              '<br> name: ' +json.name + 
                                      '</b>');
      }
      else if (jobType == 'getRefNameList') {
        refNameList.push(json);
      }
      else if (jobType == 'getBases') {
        basesData = json;
        var seqData = [];                       // returned Sequence stored
        

        var idx = 0;
        for (var i=0; i<json.sequence.length; i++) {
          seqData.push(json.sequence[i]);
          //if (i % 99 == 1) { 
          //  idx = idx + 1;
          //  seqData[idx] = new Array();
          //}
        }

        //////// Print sequence output as text format
        if (userCommand == 'sequence') {
          $('#output_container').empty();
          $('#output_container').append ('offset: <b>'+ json.offset + 
                                                '</b><br> sequence (each line - 100 bases): ' + '<br>');
          console.log("Sequence size: " +seqData.length);
          var count = 0;;
          for (var i=0; i<seqData.length; i++) {
            count = count + 1;
            $('#output_container').append ('<b>' + seqData[i] + '</b>');
            if (count == 100) {
              $('#output_container').append ('<br>');
              count = 0;
            }
          }
        }
        ////////  Generate Sequence Map - BioJS ////////
        testSeq = seqData;                      // get returneed data for testing
        testSeq_string = testSeq.join('');
        //genSequenceMap(seqData);                // call sequence map generator
        $('#seq_holder').empty();                 // clean sequence map canvas
        if (userCommand == 'alignment') {
          chkSeqAlignment(seqData);
          genSequenceMap(seqData);                // call sequence map generator
        }
        else {
          genSequenceMap(seqData);                // call sequence map generator
        }
      }
      //document.getElementById('output_container').innerHTML += '<br />' + '<b>CallSet ID: </b>' + JSONdata;
      
      }
    });
}
function genSequenceMap (seq) {
  var theSequence = seq.join('')      // stores all sequence as one string
  //var theSequence = seq_string;
  $('#seq_holder').empty();
  console.log("generate Sequence Map\n The sequence: " + theSequence);

  //window.onload = function() {
    $.browser = require("jquery-browser-plugin");

    var Sequence = require("biojs-vis-sequence");
    var mySequence = new Sequence({
      sequence : theSequence,
      target : "seq_holder",
      format : 'CODATA',
      formatOptions : {
        title:true,
        footer:false
      },
      id : refID_input
    });

    mySequence.onAll(function(name,data){
      console.log(arguments);
        if (name == 'onSelectionChanged') {
          getUserEvent = data;
        }
    if (getUserEvent!="" && getUserEvent.start!=getUserEvent.end) {
      mySequence.addHighlight( { "start": getUserEvent.start, "end": getUserEvent.end, "color": "white", "background": "green", "id": "abc" } );
    }
  });
  //}
}

function chkSeqAlignment (seq) {
  align_pos_start = [];         // reset 
  align_pos_end = [];
  var foundMatch = 0;
  var refSequence = seq.join('');
  var Qseq = query_seq.replace(/\n|\r|\s/g,"");
  //var Qseq = new RegExp("^"+Qseq+"$");
  var Qseq = new RegExp(Qseq,"g");
  console.log("Qseq:\n" + Qseq);
  while ( match = Qseq.exec(refSequence) ) {
    var output;
    var start_position = parseInt(seq_start) + parseInt(match.index) + 1;
    var end_position = start_position + parseInt(match[0].length) - 1;
    align_pos_start.push(parseInt(match.index) + 1);
    align_pos_end.push( (parseInt(match.index) + 1) + parseInt(match[0].length) - 1 );
    if (end_position > seq_end) {
      alert("Err - endposition")            // for testing
    }
    if (match){
      foundMatch = 1;
      output = ("match found at " + start_position + ' // ' + end_position );
      $('#chk_match').append(output + '<br>');
    }
  }
  if (foundMatch == 0) { 
    $('#chk_match').append("<b>The query sequence is <u>NOT</u> matched!!</b>")
  }
}

function updateReferenceMenu (list) {
  $('#refIdSelector').empty();
  for (var i=0; i<list.referenceIds.length; i++) {
    $('#refIdSelector').append('<option>'+list.referenceIds[i]+'</option>');
  }
  $('#refCount').append('ref.ID count: ' + list.referenceIds.length + '&nbsp;&nbsp;');

  //updateReferenceMenu_validList()
}

var test_list;
function updateReferenceMenu_validList (list) {
  test_list = list;
  $('#refIdSelector_valid').empty();
  $('#valid_refCount').empty();
  for (var i=0; i<list.length; i++) {
    $('#refIdSelector_valid').append('<option>'+list[i].id+' ('+list[i].name+')</option>');
  }
  $('#valid_refCount').append('Valid ref.ID count: ' + list.length);
}

///////////////////////////////////////////////////////////////////////
//       TODO LIST
// 1. Add annotation on pviz using passed positions and aligned sequence
// 2. To find how to display external html into one html page.
//    It is the way of implementation pviz into main page. 
// 3. Add auto position changer.


</script>
</body>
