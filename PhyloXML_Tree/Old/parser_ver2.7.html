<html>
  <head>
    <title> XML to JSON converter </title>
    
    <script type="text/javascript" src="js/jkl-dumper.js" charset="Shift_JIS"></script>
    <script type="text/javascript" src="js/jkl-parsexml.js"></script>
    <script type="text/javascript" src="js/loadxmldoc.js"></script> 
    <script type="text/javascript" src="js/expandCollapse.js"></script>
    <script type="text/javascript" src="js/jquery.js"></script>  

    
    <meta charset = "utf-8">
    
    </head>
  
  <body>
        <h1 id="title" align="center"> XML to JSON parser - ver. 2.7 </h1>
        <div id="usage" style="display:none">
            <h4 > Usage: </h4>
            <ul>
                <li> Choose your phyloXML format File from local drive </li>
                <li> Press "Modifying XML" button that will generate modified xml file for converting to JSON file. </li>
                <li> Press "Parsing XML" button then converted JSON data will be shown below. </li>
                <li> TODO: generate JSON file automatically then pass the file to Radial tree script.</li>
            </ul>
        </div>
        <div>
        <input type="button" onclick="return toggleMe('usage')" value="+Show Usage">
        </div>

        <form action="run_modifyXML.php" method="post" enctype="multipart/form-data">
            <input type="file" id="file" name="file"  />
            <output id="list"></output>
            <output id="listName" style="display: none"></output>
            <input type="submit" name="submit" value="1.Modifying XML">
        <form>

        <INPUT TYPE="button" Value="2.Parsing XML" onClick="parser()" />
        <INPUT TYPE="button" Value="3.Generate Tree" id="sendData" />

        <p id="parsed" style="padding: 4px; background: teal;">
        </p>  
    
        
    
    <script type="text/javascript">

        var chk_modify = false;
        var chk_parsing = false;
        var filename;
        var newText; // stores parsed JSON data

        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object

            // files is a FileList of File objects. List some properties.
            // <input type="file" id="files" name="files[]" multiple />    // accept multiple files
            
            var output = [];            
            for (var i = 0, f; f = files[i]; i++) {
                output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ', f.size, ' bytes, last modified: ', f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a', '</li>');

                filename = f.name;  // get filename
            }
            document.getElementById('listName').innerHTML = filename;
            document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
        }

        // select user file from the user local drive
        document.getElementById('file').addEventListener('change', handleFileSelect, false);


        function parser() {
            
            /////// Set the modified file name.
            //////  This must be changed if the modifyXML.py has been changed.
            var url = "uploaded/modified_" + filename;
            var xml = new JKL.ParseXML( url, null );
            xml.setOutputArrayElements( ["clade"], ["name"] );
            var data = xml.parse();
            
            var dumper = new JKL.Dumper();
            var text = dumper.dump( data );
            
            var outData = output(text);
            var Datalength = outData.length;

            saveJSON(outData);
            //genTree();
            //document.getElementById( "parsed" ).innerHTML = outData;
            
            function output(text) {
                /*
                if ( typeof(text) == "undefined" ) return "";
                text = text.replace( /&/g, "&amp;" ).replace( /</g, "&lt;" ).replace( />/g, "&gt;" ).replace( /\n/g, "<br>\n" ).replace( / /g, "&nbsp;" ).replace(new RegExp('(.*)phylogeny(.*)', 'g'), '').replace(/"clade"/g, '"children"').replace(/"#text"/g, '"text"').replace(/"rooted"/g, '"name"').replace(/"true"/g, '"ROOT"');
                */
                if ( typeof(text) == "undefined" ) return "";
                text = text.replace(new RegExp('(.*)phylogeny(.*)', 'g'), '').replace(/"clade"/g, '"children"').replace(/"#text"/g, '"text"').replace(/"rooted"/g, '"name"').replace(/"true"/g, '"ROOT"').replace(/"confidence"/g, '"property"').replace(/""name"":/g,"").replace(/""ROOT","/g, "");

                // newText contains parsed valid JSON data
                // To remove last '}' for valid JSON data (removed parent 'phylogeny')
                newText = text.substr(text.indexOf("{"), text.lastIndexOf("}")-1); 
                
                return newText;
            }

        }

        function saveJSON(outData) {
            //var outData = "HELLO WORLD!";
            var name = filename;
            $.ajax({
                type: "POST",
                url: "saveJSON.php",
                data: { jsonData: outData, XMLname: name },
                success: function(data)
                {
                    console.log("success AJAX!");
                    $('#parsed').html(data)
                }
            })
        }

        
        $(function () {
            $("#sendData").bind("click", function () {
                console.log("CALLED - click()")
                window.open('Radial_Tree_Collapsible_ver2.7.html');
            });
        });
        


            
    </script>

</html>
