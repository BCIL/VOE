<html lang="en">
<head>
  <title> Using Google API - test ver. </title>
  <script src="/js/jquery.js" charset="utf-8"></script>
  <script src="/js/bootstrap.js"></script>
  <!-- The googlegenomics plugin can be sourced directly from rawgit.com -->
  <script src="/js/googlegenomics.jquery.js"></script>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  
  <style type="css/text">
    
    form {
      text-align: center;
      width: 400px;
      padding: 1em;
      border: 1px solid #CCC;
      border-radius: 1em;
    }
    form div + div {
      margin-top: 1em;
    }
    label {
      display: inline-block;
      width: 90px;
      text-align: right;
    }
    input {
      font: 1em sans-serif;
      width: 300px;
      --moz-box-sizing: border-box;
      box-sizing: border-box;
      border: 1px solid #999;
    }
  </style>
</head>

<script>
// <input type="text" class="form-control" id="callSetId" value="10473108253681171589-0"/>
</script>
<body>
<h1 id="DEMO" style="text-align: center"> Google Genomic API - Datasets </h1>

<form id="dataInput" action = "" methos="post" >
  <div class="form-group">
    <label for="callSetId">Select your callset ID</label>
    <select class="id-control" id="idSelector" onchange="getCallId(this)">
    <option type="text" class="form-control" id="callSetId" value="NuLL"> Selet ID </option>
    <option type="text" class="form-control" id="callSetId" value="10473108253681171589-0"> 1000 genomes </option> <!-- HG00096 in 1000 genomes -->
    <option type="text" class="form-control" id="callSetId" value="4252737135923902652-0"> 1000 genomes - Phase 3 </option>
    <option type="text" class="form-control" id="callSetId" value="3049512673186936334-0"> Illumina Platinum Genomes </option>
    </select>
  </div>
  <div class="projectNumber">
    <label for="projectNumber"> Project Number: </label> 
    <input id="projectNumber", value="639017132977"> <text style="font-size: 12"> default value</text>
  </div>
  <div class="jobType">
  <label for="jobType"> Job type: </label> &nbsp;
  <input type="radio" name="jobType1" value="create"> Create &nbsp;
  <input type="radio" name="jobType1" value="delete"> Delete &nbsp;
  <input type="radio" name="jobType1" value="get"> Get &nbsp;
  <input type="radio" name="jobType1" value="list"> List &nbsp;
  <input type="radio" name="jobType1" value="update"> Update &nbsp;
  </div>
  <div class="datasetId">
    <label for="datasetId"> Dataset ID: </label> 
    <input id="datasetId" style="indent: 5em;">
  </div>
  <div class="isPublic">
    <label for="isPublic"> isPublic: </label>
    <input type="checkbox" id="isPublic" value="public" checked> </div> 
  </div>
  <div class="name">
    <label for="name"> Name: </label> 
    <input id="name"> 
  </div>
  <div class="pageSize">
    <label for="pageSize"> Page size: </label> 
    <input id="pageSize"> 
  </div>
  <div class="pageToken">
    <label for="pageToken"> Page token: </label> 
    <input id="pageToken"> 
  </div>
  <br>
  <div class="create_button">
    <input type="button" name="button" value="Submit" onclick="getUserInput()"> </button>
  </div>
</form>

<br>
<p id="outContainer_title" style="margin-left: 50px"><b>================== OUTPUT CONTAINER ==================</b></p>
<div class="output_container" id="output_container" style="width: 600px; margin-top: 20px; margin-left: 50px;"> 
</div>

<script type="text/javascript">

// My ID
var clientId = "639017132977-tnhsbqtbrb5tjmrbb6q0clojthsank45.apps.googleusercontent.com";
var callSetId = "NULL";
var jobType = "NULL";
var jobType_chk = 0;

// clientId chk
if (!clientId) {
  alert('A client ID is required. Please push one to the url: ' +
      'http://localhost:8000/traitviewer#my-client-id');
} else {
  console.log("clientId: " + clientId);
  $.initGenomics({clientId: clientId});
}

function getCallId(option) {
  callSetId = option[option.selectedIndex].value;
  ShowCallsetId();
  console.log("CALL_ID: " + callSetId);
}

(function() {
    jobType = document.forms['dataInput'].elements['jobType1'];
    for (var i=0, len=jobType.length; i<len; i++) {
      jobType[i].onclick = function() { jobType = this.value; ShowJobType(); jobType_chk = 1;}
    }
/*
    // disable submission of all forms on this page
    for (var i=0, len=document.forms.length; i<len; i++) {
        document.forms[i].onsubmit = function() { return false; };
    }    
*/    
}());

function getUserInput() {
  if ( jobType_chk == 0 ) { alert("select jobType!"); return; }
  //else if (callSetId == "NULL") { alert("select callSet ID!"); return; }
  else {
    document.getElementById("output_container").innerHTML = "";
    var InputList = [];
    var inForm = document.forms[0];
    
    var callSetId = callSetId;
    var projectNumber = inForm.projectNumber.value;
    var datasetId = inForm.datasetId.value;
    var isPublic = inForm.isPublic.checked;   // true: public, false: private
    var name = inForm.name.value;
    var pageSize = inForm.pageSize.value;
    var pageToken = inForm.pageToken.value;
    
    console.log("\t=============== USER INPUT ==============="
                +"\n\tCallsetID: " + callSetId 
                +"\n\tProjectNumber: " + projectNumber
                +"\n\tDatasetId: " + datasetId
                +"\n\tisPublic: " + isPublic
                +"\n\tName: " + name
                +"\n\tPageSize: " + pageSize
                +"\n\tPageToken: " + pageToken
                );
    
    InputList.push(callSetId);        // 0    
    InputList.push(projectNumber);    // 1
    InputList.push(datasetId);        // 2
    InputList.push(isPublic);         // 3
    InputList.push(name);             // 4
    InputList.push(pageSize);         // 5
    InputList.push(pageToken);        // 6
    
    prepSendData(InputList);
  }
}

function prepSendData(list) {
  switch (jobType) {
    case "create": {
        var params = {
          projectNumber: list[1],
          name: list[4],
          isPublic: list[3]
        };
        var url = '/datasets';
        var method = 'POST';
        console.log(" ## REQUEST : " + JSON.stringify(params) );
        sendData(list[0], params, url, method);   // list[0] == callSetId
      break;
    }
    case "delete": {
        var params = {
          datasetId: list[2]
          };
          var url = '/datasets/datasetId';
          var method = 'DELETE'
          console.log(" ## REQUEST : " + JSON.stringify(params) );
          sendData(list[0], params, url, method);   // list[0] == callSetId
        break;
    }
    case "get": {
        var params = {
          datasetId: list[2] 
        };
        var url = '/datasets/datasetId';
        var method = 'GET';
        console.log(" ## REQUEST : " + JSON.stringify(params) );
        sendData(list[0], params, url, method);   // list[0] == callSetId
      break;
    }
    case "list": {
        var params = {
          projectNumber: list[1],
          pageSize: list[5],
          pageToken: list[6] 
        };
        var url = '/datasets';
        var method = 'GET';
        console.log(" ## REQUEST : " + JSON.stringify(params) );
        sendData(list[0], params, url, method);   // list[0] == callSetId
      break;
    }
    case "update": {

      break;
    }
  }
}

function ShowCallsetId() {
 //document.getElementById('output_container').innerHTML += '<br />' + '<b>Client ID: </b>' + clientId;
  //document.getElementById('output_container').innerHTML += '<br />' + '<b>CallSet ID: </b>' + callSetId;
}
function ShowJobType() {
  //document.getElementById('output_container').innerHTML += '<br />' + '<b>jobType: </b>' + jobType;
}

function Abort_execution() {
  throw new Error("Error - Undefined Call set ID")
}

var JSONdata;
function sendData (callSetId, params, url, method) {
  $.genomicsAjax ( url, {
    version: 'v1beta2',
    method: method,
    data: JSON.stringify(params),
    success: function(json) {
      console.log("#### Success to return JSON! ####");
      document.getElementById('output_container').innerHTML += "<p><b> Sucess! </b></p>";

      JSONdata = json;
      //document.getElementById('output_container').innerHTML += '<br />' + '<b>CallSet ID: </b>' + JSONdata;
      if (method == "GET") {
        for (var i in JSONdata.datasets) {
          var br = "";
          var count = 0;
          for (var prop in JSONdata.datasets[i]) {
            if (count == 3) {br = "<br>"}
            if (JSONdata.datasets[i].hasOwnProperty(prop)) {
              document.getElementById('output_container').innerHTML += '<br /><b>' + prop +":</b> "+ JSONdata.datasets[i][prop] + br;  
            }
            count = count + 1;
            //console.log ("BR: " + br);
          }
        }
      }

      else {   
        for (var prop in JSONdata) {
          if (JSONdata.hasOwnProperty(prop)) {
            document.getElementById('output_container').innerHTML += '<br /><b>' + prop +":</b> "+ JSONdata[prop];  } };
      }
    }
  });
}























function scoreAllele(callSetId, allele, number, totals) {
  console.log("scoreAllele call");

  var params = {
    referenceName: allele.contig,
    // Note: the variants API uses 0-based coordinates
    start: allele.position,
    end: allele.position + 1,
    callSetIds: [callSetId]
  };

  //console.log( "params DATA: " + params.referenceName + " // " + params.start + " // " + params.end + " // " + params.callSetIds );
  // Search over the variants at each contig position to see what
  // genotype the call set has.
  var index = 0;
  var JSON_index=0;
  console.log(" ## REQUEST : " + JSON.stringify(params) );
  $.genomicsAjax('/variants/search', {
    version: 'v1beta2',
    method: 'POST',
    data: JSON.stringify(params),
    success: function(json) {
      console.log("#### Success to return JSON! ####");
      JSONdata = json;
      
      //for (var i=0; i<json.variants.length; i++) {
      //  JSONdata[JSON_index].push(json.variants[i]);
      //}

      // Access: JSONdata.variants[index].blah
      console.log("-- referenceBases: " + JSONdata.variants[index].referenceBases);
      index = index + 1;
      JSONdata2 = getGenotype(json.variants || [], allele.position, callSetId);
      //console.log("Json return data : \n" + json);
      var callSetGenotype = getGenotype(json.variants || [],
          allele.position, callSetId);

      var matchesAllele = callSetGenotype.indexOf(allele.allele) != -1;
      var callSetScore = matchesAllele ? allele.score : 0;


      $("#callSetAllele" + number).text(callSetGenotype.join(";"));
      $("#callSetScore" + number).text(callSetScore).parent()
          .addClass(matchesAllele ? "success" : "");

      totals.score += callSetScore;
      totals.finished++;


      // Once all the alleles have been loaded, display the total score
      if (totals.finished == totals.count) {
        var description = "";
        for (var i = 0; i < currentPanel.scoreBands.length; i++) {
          var band = currentPanel.scoreBands[i];
          if (totals.score >= band.score) {
            description = band.description;
            break;
          }
        }

        $("#scoreButton").button('reset');

        var scoreDiv = $("#totalScore");
        $("<div>").text(totals.score).pushTo(scoreDiv);
        $("<div>").text(description).pushTo(scoreDiv);
      }
    }
  });
}

function getGenotype(variants, position, callSetId) {
  // Excessively complicated logic to figure out the actual genotype for
  // a call set at a given spot
  console.log("getGenotype call // Variants size: " + variants.length);
  for (var i = 0; i < variants.length; i++) {
    var variant = variants[i];                // usually returned length: 1
    if (variant.start != position) {          // check & match position
      continue;                   
    }

    for (var c = 0; c < variant.calls.length; c++) {
      var call = variant.calls[c];
      if (call.callSetId != callSetId) {      // check & match callSetId
        continue;
      }

      var genotype = [];
      for (var g = 0; g < call.genotype.length; g++) {
        var allele = call.genotype[g];
        if (allele == 0) {
          genotype.push(variant.referenceBases);
        } else {
          genotype.push(variant.alternateBases[allele - 1]);
        }
      }

      console.log ("Returned Genotype: " + genotype);
      return genotype;
    }
  }

  return ["unknown"];
}

</script>
</body>
