<html>
<head>
  
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="/js/jquery.js"></script>
  <link rel="stylesheet" href="./css/d3.linechart.css">
  <script src="./js/d3.core.js" charset="utf-8"></script>
  <script src="./js/d3.linechart.js" charset="utf-8"></script>
  
  <meta charset="utf-8">
  <style>

  body {
    font-family: sans-serif;
    position: relative;
    width: 95%;
    margin-left: auto;
    margin-right: auto;
  }

  .axis text {
    font: 10px sans-serif;
  }

  label {
    text-align: right;
    position: relative;
    top: 10px;
    right: 10px;
    margin-right: 10%;
  }
  input {
    width: 50px;
  }

  </style>
</head>
<body>

<div>
<span id="chr_label"> Chromosome:&emsp;</span>

<select class="chr_control" id="chr_selector"> 
  <option type="text" class="form-control" id="null" value="null"> select.. </option>
</select>
<button id="all_chr">All chromosomes</button>
</div>

<span> Number of Bins:&emsp;</span>
<input type="text" id="pos_num" name="peakNumber" value='10' disabled="true" />&emsp;&emsp;
<button id="update_btn" disabled="true"> update </button>

<div id="linechart"></div>


<script>

Array.prototype.unique = function() {
    var o = {}, i, l = this.length, r = [];
    for(i=0; i<l;i+=1) o[this[i]] = this[i];
    for(i in o) r.push(o[i]);
    return r;
};

var chr_list = [];
var chr_list_uniq = [];
var chr_list_count = [];

var data_list = new Array();        // stores all chr data and number of each chr.
var main_graph_chk = 1;

$(document).ready(function() {
  d3.tsv("data2.bed", function(error, data) {
  //d3.tsv("data.tsv", function(error, data) {

    window.data_tsv = data;
    
    data.forEach(function(d) {
      d.start = +d.start;
      //console.log( d.chromosome + " // " + d.start);
      chr_list.push({
        name: d.chromosome,
        position: d.start
        //score: d.score
      })
      chr_list_uniq.push(d.chromosome);
      //chr_list_uniq.unique();
    }); 

    //// eleminating duplicate chr. name
    chr_list_uniq = chr_list_uniq.unique();        
    
    var category = {};
    category.key = 'Chromosome';
    category.values = new Array();
    chr_list_uniq.forEach(function(d) {
      var n = ""
      var max_val = -1;
      var count = 0;
      for (var k=3; k<d.length; k++) { n += d[k]; }
        
      $("#chr_selector").append("<option>" + d + "</option>")
      
      for (var i=0; i<chr_list.length; i++) {
        if (chr_list[i].name === d) {
          //category.value.push({x: chr_list[i].position, y: })
          count += 1;
        }   
      }
      chr_list_count.push({
        chromosome: d,
        count: count
      })
      category.values.push({x:n, y:count, name:d})        // chr list data
    })
    data_list.push(category);

    window.min = d3.min(data, function(d) { return d.start; })
    var max = d3.max(data, function(d) { return d.start; })
    var min_margin = parseInt(min) - parseInt(min/10)
    var max_margin = parseInt(max) + parseInt(min/10)

    var max_chrCount = d3.max(chr_list_count, function(d) { return d.count })
    var min_chrCount = d3.min(chr_list_count, function(d) { return d.count })

    d3.select("#chr_selector").on("change", update_chart);
    //d3.select("#update").on("change", update_chart);

/////////////////////////////////////////////////////////////////////////////////////////
    // display all chromosome data chart first.
    getAllchrChart();
 
  // All chromosome data button   
    $("#all_chr").on("click", function() {
      main_graph_chk = 1;
      getAllchrChart();
      document.getElementById("update_btn").disabled = true;
      document.getElementById("pos_num").disabled = true;

      /*
      var newData = new Array();
      var year = getRandomInt(2005, 2014);
      var numCategories = 1;
      for (var i=0; i<numCategories; i++) {
        var category = {};
        category.key = "category "+i;
        category.values = new Array();
        for (var j=year; j<=2015; j++) {
          category.values.push({ x: j, y: getRandomInt(-50, 50) });
        };
        newData.push(category);
      }
      window.nd = newData;
      
      linechart.dataset = newData;
      linechart.update();
      */
    });
    
    $("#update_btn").on("click", function() {
      //console.debug("update!")
      update_chart();
    })

    function update_chart(option) {
      document.getElementById("update_btn").disabled = false;
      document.getElementById("pos_num").disabled = false;

      window.data_list_update = new Array();
      window.data_list_range = new Array();

      var st = document.getElementById("chr_selector");
      var chr_name = st.options[st.selectedIndex].value;
      window.c_list = [];
      window.c_list2 = [];
      c_list2.key = chr_name;
      c_list2.values = new Array();
      var n=0;

      chr_list.forEach(function (d) {
        //n+=1;                                             // idx + 1;  start from 1
        if (d.name === chr_name) {
          c_list.push(d.position)
          //c_list2.values.push({x:n, y:d.position, name:chr_name})        // chr list data
        }
      })

      for (var i=0; i<c_list.length; i++) {
        c_list2.values.push({x:i+1, y:c_list[i], name:chr_name})        // chr list data 
      }
      data_list_update.push(c_list2);
      
      var low = d3.min(c_list);
      var high = d3.max(c_list);
      var size = c_list.length;
      var item_num = parseInt($("#pos_num").val());
      var pos_range = parseInt(high / item_num);        // set as 10 ranges on x-axis, start from position 0
      window.item_list = new Array(item_num);
      var item_count = new Array(item_num);
      var dr = [];
      dr.key = chr_name;
      dr.values = new Array();

      for (var k=0; k<item_list.length; k++) {
        item_list[k] = (pos_range*(k+1));
        item_count[k] = 0;
      }

      //var pos1=(pos_range*1);var pos2=(pos_range*2);var pos3=(pos_range*3);var pos4=(pos_range*4);var pos5=(pos_range*5);var pos6=(pos_range*6);var pos7=(pos_range*7);var pos8=(pos_range*8);var pos9=(pos_range*9);var pos10=(pos_range*10);
      
      //var p1=0,p2=0,p3=0,p4=0,p5=0,p6=0,p7=0,p8=0,p9=0,p10=0;
      /*
      for (var j=0; j<c_list.length; j++) {
        var curr = c_list[j];
        if (curr < pos2) {p1+=1;}
        else if (pos1< curr && curr < pos3) {p2+=1;}
        else if (pos2< curr && curr < pos4) {p3+=1;}
        else if (pos3< curr && curr < pos5) {p4+=1;}
        else if (pos4< curr && curr < pos6) {p5+=1;}
        else if (pos5< curr && curr < pos7) {p6+=1;}
        else if (pos6< curr && curr < pos8) {p7+=1;}
        else if (pos7< curr && curr < pos9) {p8+=1;}
        else if (pos8< curr && curr < pos10) {p9+=1;}
        else {p10+=1;}
      }
  */
      for (var j=0; j<c_list.length; j++) {
        var curr = c_list[j];
        for (var m=item_list.length-1; m>0; m--) {
          if (curr > item_list[m-1] && curr < item_list[m]) {
            item_count[m]+=1;
          }
        }
      }

      for (var n=0; n<item_list.length; n++) {
        dr.values.push({x:item_list[n], y:item_count[n]});
      }
      /*
        dr.values.push({x:pos1, y:p1});
        dr.values.push({x:pos2, y:p2});
        dr.values.push({x:pos3, y:p3});
        dr.values.push({x:pos4, y:p4});
        dr.values.push({x:pos5, y:p5});
        dr.values.push({x:pos6, y:p6});
        dr.values.push({x:pos7, y:p7});
        dr.values.push({x:pos8, y:p8});
        dr.values.push({x:pos9, y:p9});
        dr.values.push({x:pos10, y:p10});
  */

      data_list_range.push(dr);

      
      if (main_graph_chk == 1) {
        main_graph_chk = 0;
        $("#linechart").empty();
        window.linechart = new D3LineChart({ 
        container: "#linechart",
        data: data_list_range,
        displayTable: false,
        yTicks: 30,
        tooltipText: function(d, element) { 
          window.test_d = d;
          window.test_e = element;
          var curr_pos = d.x;
          window.prev_pos;
          for (var i=0; i<item_list.length; i++) {
            if (item_list[i] == curr_pos) {
              if (i==0) { prev_pos = 0; }
              else { prev_pos = item_list[i-1]; }
            }
          }
          return "<p>count: "+d.y+"<br/>position: "+prev_pos+" - "+ curr_pos + "<p>"; }
        });
        linechart.show();
      }
      else {
        linechart.dataset = data_list_range;
        linechart.update();
      }
      //c_list2.values.push({x:n, y:count, name:chr_name})        // chr list data


      /*
      var st = document.getElementById("chr_selector");
      var chr_name = st.options[st.selectedIndex].value;
      window.c_list = [];
      chr_list.forEach(function (d) {
        if (d.name === chr_name) {
          c_list.push(d.position)
        }
      })

      c_list_reformed = c_list.map(function(obj){ 
        var rObj = {};
        rObj[obj.chromosome] = obj.count;
        return rObj;
      });

      var low = d3.min(c_list);
      var high = d3.max(c_list);
      var size = c_list.length;
      */
    }

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getAllchrChart() {
      $("#linechart").empty();
      window.linechart = new D3LineChart({ 
      container: "#linechart",
      data: data_list,
      displayTable: false,
      yTicks: 10,
      xTickFormat: function(d) { return 'chr' + d },
      tooltipText: function(d, element) { return "<p>name: "+d.name+"<br />count: "+d.y+"<p>"; }
      });
      
      linechart.show();
    }


  });
});

</script>
</body>
<html>
